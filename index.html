<!DOCTYPE html>


<title>Countries</title>
<meta charset="utf-8">
<script src="leaflet.js"></script>
<link rel="icon" href="flags/earth_icon.png">
<link rel="stylesheet" type="text/css" href="leaflet.css" />
<link rel="stylesheet" type="text/css" href="style.css"/>


<body onload="load_data();">
  <div class="bg"></div>
  <div class="content">
    <a href="index.html" style="text-decoration: none"><h1><hiddentag>Les pays d'Europe</hiddentag></h1></a>
    <table>
      <tr>
        <td id="desc_content">
          <p id="description">
            <div id="error_msg"></div>
            <div id="country_data" hidden="true">
              <h2 id="country_name"></h2>
              <ul>
                <li id="name"></li>
                <li id="capital"></li>
                <li id="latitude"></li>
                <li id="longitude"></li>
                <li id="population"></li>
                <li id="continent"></li>
                <li id="area"></li>
                <li>Si vous voulez en savoir plus : <a id="wp">Wikipedia link</a></li>
              </ul>
            </div>
          </p>
        </td>
        <td id="map_content">
          <div id="map" style="margin-bottom:1.33em"></div>
        </td>
      </tr>
    </table>
  </div>
</body>


<script>
var map = L.map('map').setView([20,20], 1.4);

L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

function load_data () {
  var xhr = new XMLHttpRequest();
  xhr.onload = function() {
    var data = JSON.parse(this.responseText);
    for ( n = 0; n < data.length; n++ ){
      if (data[n].continent == 'Europe'){
        var myIcon = L.icon({
          iconUrl: 'images/marker-icon-red.png',
          iconAnchor: [12,41],
          popupAnchor: [0, -41],
          shadowUrl: 'images/marker-shadow.png',
        });
      }else{
        var myIcon = L.icon({
          iconUrl: 'images/marker-icon-green.png',
          iconAnchor: [12,41],
          popupAnchor: [0, -41],
          shadowUrl: 'images/marker-shadow.png',
      });
    };

    var x, selElmnt;
    x = document.getElementsByClassName("custom-select");
    for (i = 0; i < x.length; i++) {
      selElmnt = x[i].getElementsByTagName("select")[0];
      selElmnt.innerHTML += '<option value="'+String(n+1)+'" id="'+data[n].wp+'">'+data[n].capital+' ('+data[n].wp.replace(/_/g," ")+')'+'</option>'
    };

    L.marker([data[n].lat,data[n].lon], {icon: myIcon}).addTo(map).bindPopup(data[n].capital+' ('+data[n].wp.replace(/_/g," ")+')').addEventListener('click',OnMarkerClick).idnum = data[n].wp;
  };






  var x, i, j, selElmnt, a, b, c;
  /* Look for any elements with the class "custom-select": */
  x = document.getElementsByClassName("custom-select");
  for (i = 0; i < x.length; i++) {
    selElmnt = x[i].getElementsByTagName("select")[0];
    /* For each element, create a new DIV that will act as the selected item: */
    a = document.createElement("DIV");
    a.setAttribute("class", "select-selected");
    a.innerHTML = selElmnt.options[selElmnt.selectedIndex].innerHTML;
    x[i].appendChild(a);
    /* For each element, create a new DIV that will contain the option list: */
    b = document.createElement("DIV");
    b.setAttribute("class", "select-items select-hide");
    for (j = 1; j < selElmnt.length; j++) {
      /* For each option in the original select element,
      create a new DIV that will act as an option item: */
      c = document.createElement("DIV");
      c.innerHTML = selElmnt.options[j].innerHTML;
      c.addEventListener("click", function(e) {
          /* When an item is clicked, update the original select box,
          and the selected item: */
          var y, i, k, s, h;
          s = this.parentNode.parentNode.getElementsByTagName("select")[0];
          h = this.parentNode.previousSibling;
          for (i = 0; i < s.length; i++) {
            if (s.options[i].innerHTML == this.innerHTML) {
              s.selectedIndex = i;
              h.innerHTML = this.innerHTML;
              y = this.parentNode.getElementsByClassName("same-as-selected");
              for (k = 0; k < y.length; k++) {
                y[k].removeAttribute("class");
              }
              this.setAttribute("class", "same-as-selected");
              break;
            }
          }
          h.click();
          if (document.getElementsByTagName("select")[0].selectedIndex!=0 && document.getElementsByTagName("select")[1].selectedIndex!=0){
            capital_distance(document.getElementsByTagName("select")[0], document.getElementsByTagName("select")[1]);
          };
      });
      b.appendChild(c);
    }
    x[i].appendChild(b);
    a.addEventListener("click", function(e) {
      /* When the select box is clicked, close any other select boxes,
      and open/close the current select box: */
      e.stopPropagation();
      closeAllSelect(this);
      this.nextSibling.classList.toggle("select-hide");
      this.classList.toggle("select-arrow-active");
    });
  };








};
  xhr.open('GET','/location',true);
  xhr.send();
}

function OnMarkerClick (e) {
  var xhr = new XMLHttpRequest();
  xhr.onload = function() {
    var data = JSON.parse(this.responseText);
    country_name.innerHTML =  '<b><i>' + e.target.getPopup().getContent() + '</i></b><br>';
    window.error_msg.innerHTML = '';
    window.cap_dist.setAttribute('hidden', 'true');
    window.country_data.style.display = 'block';
    window.country_data.hidden.boolContent = false;
    window.country_name.textContent = data.wp.replace(/_/g," ");
    window.off_name.textContent = 'Official name : '+data.name;
    window.capital.textContent = 'Capital : '+data.capital;
    window.latitude.textContent = 'Latitude : '+data.latitude.toFixed(3)+'°';
    window.longitude.textContent = 'Longitude : '+data.longitude.toFixed(3)+'°';
    window.population.textContent = 'Population : '+data.population+' inhabitants';
    window.continent.textContent = 'Continent : '+data.continent;
    window.domain_name.textContent = 'Domain name : '+data.cctld;
    window.area.textContent = 'Area : '+data.area;
    window.area.insertAdjacentHTML('beforeend', ' km<sup>2</sup>');
    window.wp.href = 'https://en.wikipedia.org/wiki/'+data.wp;
    insertCss('.bg {background-image : url(flags/'+data.wp.replace(/ /g,"_")+'.svg)}');
  };
  function insertCss( code ) {
      var style = document.createElement('style');
      style.type = 'text/css';
      if (style.styleSheet) {
          // IE
          style.styleSheet.cssText = code;
      } else {
          // Other browsers
          style.innerHTML = code;
      };
      document.getElementsByTagName("head")[0].appendChild( style );
  };
  var idnum = e.target.idnum;
  xhr.open('GET','/description/'+idnum,true);
  xhr.send();
};

function capital_distance(a, b){
  document.getElementById("distance_text").removeAttribute('hidden');
  var xhr1 = new XMLHttpRequest();
  var xhr2 = new XMLHttpRequest();
  var coord1;
  var coord2;
  var notwritten = true;
  xhr1.onload = function() {
    var data1 = JSON.parse(this.responseText);
    coord1 = [data1.longitude, data1.latitude];
    if (coord1!=undefined && coord2!=undefined && notwritten){
      notwritten = false;
      var distance = coords_distance(coord1, coord2).toFixed(0);
      window.distance_km.textContent = distance;
    };
  };
  xhr2.onload = function() {
    var data2 = JSON.parse(this.responseText);
    coord2 = [data2.longitude, data2.latitude];
    if (coord1!=undefined && coord2!=undefined && notwritten){
      notwritten = false;
      var distance = coords_distance(coord1, coord2).toFixed(0);
      window.distance_km.textContent = distance;
      if (distance==0){
        window.same_cap.innerHTML = 'You could have done it yourself!';
      }else{
        window.same_cap.innerHTML = '';
      };
    };
  };
  var idnum1 = a.selectedOptions[0].id;
  var idnum2 = b.selectedOptions[0].id;
  xhr1.open('GET','/description/'+idnum1,true);
  xhr2.open('GET','/description/'+idnum2,true);
  xhr1.send();
  xhr2.send();
};


function coords_distance(coord1, coord2){
  var lat1 = coord1[1];
  var lon1 = coord1[0];
  var lat2 = coord2[1];
  var lon2 = coord2[0];
  var R = 6371; // km
  var dLat = toRad(lat2-lat1);
  var dLon = toRad(lon2-lon1);
  var lat1 = toRad(lat1);
  var lat2 = toRad(lat2);

  var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2);
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  var d = R * c;
  return d;
};
function toRad(Value){
  return Value * Math.PI / 180;
};



function ffalse(){return false;};
function ftrue(){return true;};
document.onselectstart = new Function ("return false");
if(window.sidebar){
  document.onmousedown = ffalse;
  document.onclick = ftrue;
};



function closeAllSelect(elmnt) {
  /* A function that will close all select boxes in the document,
  except the current select box: */
  var x, y, i, arrNo = [];
  x = document.getElementsByClassName("select-items");
  y = document.getElementsByClassName("select-selected");
  for (i = 0; i < y.length; i++) {
    if (elmnt == y[i]) {
      arrNo.push(i)
    } else {
      y[i].classList.remove("select-arrow-active");
    }
  }
  for (i = 0; i < x.length; i++) {
    if (arrNo.indexOf(i)) {
      x[i].classList.add("select-hide");
    }
  }
}
/* If the user clicks anywhere outside the select box,
then close all select boxes: */
document.addEventListener("click", closeAllSelect);
</script>
